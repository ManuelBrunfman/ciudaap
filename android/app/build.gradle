// RUTA: android/app/build.gradle
// Configuración para EXPO DEV CLIENT + Firebase nativo + Producción

apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

// OBLIGATORIO: Firebase Google Services
apply plugin: "com.google.gms.google-services"

// Aplicar Expo modules después de verificar que existe
def expoModulesPlugin = new File(rootDir, "../../node_modules/expo-modules-gradle-plugin/expo-modules-gradle-plugin.gradle")
if (expoModulesPlugin.exists()) {
    apply from: expoModulesPlugin
}

android {
    namespace "com.labancaria.bancapp"
    
    // Usa las versiones de gradle.properties
    compileSdkVersion 34
    buildToolsVersion "34.0.0"
    ndkVersion "26.1.10909125"

    defaultConfig {
        applicationId "com.labancaria.bancapp"
        minSdkVersion 24
        targetSdkVersion 34
        versionCode 1
        versionName "1.0"
        
        // IMPORTANTE: Para Expo + Firebase
        manifestPlaceholders = [
            appAuthRedirectScheme: 'com.labancaria.bancapp'
        ]
        
        // MultiDex necesario para Firebase
        multiDexEnabled true
    }

    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
    }

    buildTypes {
        debug {
            signingConfig signingConfigs.debug
            // Para dev client - identificador único
            applicationIdSuffix ".debug"
            debuggable true
        }
        
        release {
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile("proguard-android-optimize.txt"), "proguard-rules.pro"
            signingConfig signingConfigs.debug // Cambiar en producción
        }
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
    
    kotlinOptions {
        jvmTarget = "17"
    }

    // Soluciona conflictos con Firebase + otras dependencias nativas
    packagingOptions {
        pickFirsts += ["**/libc++_shared.so"]
        pickFirsts += ["**/libjsc.so"]
        pickFirsts += ["**/libreactnativejni.so"]
        pickFirsts += ["**/libfbjni.so"]
    }
}

// React Native + Hermes (ya configurado en gradle.properties)
react {
    enableHermes = true
}

dependencies {
    implementation("com.facebook.react:react-android")
    
    // MultiDex para Firebase
    implementation 'androidx.multidex:multidex:2.0.1'
    
    // Expo modules core
    if (findProject(':expo-modules-core')) {
        api project(':expo-modules-core')
    }
}

// Auto-linking para Expo dev client
apply from: new File(["node", "--print", "require.resolve('expo/package.json')"].execute().text.trim(), "../scripts/autolinking.gradle")